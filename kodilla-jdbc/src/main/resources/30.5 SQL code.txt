CREATE TABLE STATUS
(
    STAT_ID   INT(11) AUTO_INCREMENT PRIMARY KEY,
    STAT_DATE DATETIME    NOT NULL,
    STAT      VARCHAR(20) NOT NULL,
    VALUE     INT(11)     NOT NULL
);


CREATE VIEW BESTSELLERS_COUNT AS
SELECT COUNT(*) AS NUMBER_OF_BESTSELLERS
FROM BOOKS
WHERE BESTSELLER = TRUE;

DROP PROCEDURE IF EXISTS CREATE_NEW_STATUS;
DELIMITER $$
CREATE PROCEDURE CREATE_NEW_STATUS()
BEGIN
    DECLARE VARIABLE INT(11);
    SET VARIABLE = 0;
    CALL UpdateBestsellers();

    SELECT NUMBER_OF_BESTSELLERS
    FROM BESTSELLERS_COUNT
    INTO VARIABLE;

    select VARIABLE;

    INSERT INTO STATUS (STAT_DATE, STAT, VALUE)
        VALUE (CURTIME(), 'BESTSELLERS', VARIABLE);

END $$
DELIMITER ;

USE KODILLA_COURSE;
CREATE EVENT UPDATE_BESTSELLERS
    ON SCHEDULE EVERY 1 MINUTE
    DO CALL CREATE_NEW_STATUS();
